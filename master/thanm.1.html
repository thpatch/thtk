<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Redistribution and use in source and binary forms, with
   or without modification, are permitted provided that the
   following conditions are met:
  
   1. Redistributions of source code must retain this list
      of conditions and the following disclaimer.
   2. Redistributions in binary form must reproduce this
      list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the
      distribution.
  
   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
   CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED
   WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
   PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
   COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
   INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
   PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
   DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
   CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
   OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
   DAMAGE.
 -->
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../mandoc.css" type="text/css" media="all"/>
  <title>THANM(1)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">THANM(1)</td>
    <td class="head-vol">General Commands Manual</td>
    <td class="head-rtitle">THANM(1)</td>
  </tr>
</table>
<div class="manual-text">
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp"><code class="Nm">thanm</code> &#x2014; <span class="Nd">Touhou
    sprite archive tool</span></p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<table class="Nm">
  <tr>
    <td><code class="Nm">thanm</code></td>
    <td>[<code class="Fl">-Vfouv</code>] [[<code class="Fl">-l</code> |
      <code class="Fl">-x</code> | <code class="Fl">-X</code> |
      <code class="Fl">-r</code> | <code class="Fl">-c</code>]
      <var class="Ar">version</var>] [<code class="Fl">-m</code>
      <var class="Ar">anmmap</var>]<var class="Ar">...</var>
      [<code class="Fl">-s</code> <var class="Ar">symbols</var>]
      [<var class="Ar">archive</var> [<var class="Ar">...</var>]]</td>
  </tr>
</table>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">The <code class="Nm">thanm</code> utility performs various actions
    on sprite archives. The following commands are available:</p>
<dl class="Bl-tag">
  <dt><code class="Nm">thanm</code> <code class="Fl">-l</code>
    <var class="Ar">version</var> [<code class="Fl">-fouv</code>]
    [<code class="Fl">-m</code>
    <var class="Ar">anmmap</var>]<var class="Ar">...</var>
    <var class="Ar">archive</var></dt>
  <dd>Displays a specification of the archive.</dd>
  <dt><code class="Nm">thanm</code> <code class="Fl">-x</code>
    <var class="Ar">version</var> [<code class="Fl">-fouv</code>]
    <var class="Ar">archive</var> [<var class="Ar">file ...</var>]</dt>
  <dd>Extracts image files. If no files are specified, all files are
    extracted.</dd>
  <dt><code class="Nm">thanm</code> <code class="Fl">-X</code>
    <var class="Ar">version</var> [<code class="Fl">-fouv</code>]
    <var class="Ar">archives</var><var class="Ar">...</var></dt>
  <dd>Extracts all image files from multiple archives.</dd>
  <dt><code class="Nm">thanm</code> <code class="Fl">-r</code>
    <var class="Ar">version</var> [<code class="Fl">-fouv</code>]
    <var class="Ar">archive</var> <var class="Ar">name</var>
    <var class="Ar">file</var></dt>
  <dd>Replaces an entry in the archive. The name can be obtained by the
      <code class="Fl">-l</code> command.</dd>
  <dt><code class="Nm">thanm</code> <code class="Fl">-c</code>
    <var class="Ar">version</var> [<code class="Fl">-fuv</code>]
    [<code class="Fl">-m</code>
    <var class="Ar">anmmap</var>]<var class="Ar">...</var>
    [<code class="Fl">-s</code> <var class="Ar">symbols</var>]
    <var class="Ar">archive</var> <var class="Ar">input</var></dt>
  <dd>Creates a new archive from a specification obtained by the
      <code class="Fl">-l</code> command. It will look for referenced image
      files in the current directory.</dd>
  <dt><code class="Nm">thanm</code> <code class="Fl">-V</code></dt>
  <dd>Displays the program version.</dd>
</dl>
<p class="Pp">These options are accepted:</p>
<dl class="Bl-tag">
  <dt id="f"><a class="permalink" href="#f"><code class="Fl">-f</code></a></dt>
  <dd>The <code class="Fl">-f</code> option can be used to ignore certain
      errors.</dd>
  <dt id="m"><a class="permalink" href="#m"><code class="Fl">-m</code></a>
    <var class="Ar">anmmap</var></dt>
  <dd>The <code class="Fl">-m</code> option can be used to map ins_* to human
      readable names.</dd>
  <dt id="s"><a class="permalink" href="#s"><code class="Fl">-s</code></a>
    <var class="Ar">symbols</var></dt>
  <dd>The <code class="Fl">-s</code> option saves symbol ids to the
      <var class="Ar">symbols</var> file.</dd>
  <dt id="o"><a class="permalink" href="#o"><code class="Fl">-o</code></a></dt>
  <dd>The <code class="Fl">-o</code> option adds address information for ANM
      instructions.</dd>
  <dt id="u"><a class="permalink" href="#u"><code class="Fl">-u</code></a></dt>
  <dd>The <code class="Fl">-u</code> option extracts each texture into a
      separate file. When specified twice, x/y offset is ignored. See
      <a class="Sx" href="#IMAGE_COMPOSITION">IMAGE COMPOSITION</a> for more
      information.</dd>
  <dt id="v"><a class="permalink" href="#v"><code class="Fl">-v</code></a></dt>
  <dd>The <code class="Fl">-v</code> option increases verbosity of the output.
      It can be specified multiple times.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="EXIT_STATUS"><a class="permalink" href="#EXIT_STATUS">EXIT
  STATUS</a></h1>
<p class="Pp">The <code class="Nm">thanm</code> utility exits with 0 on success,
    1 on error.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="IMAGE_COMPOSITION"><a class="permalink" href="#IMAGE_COMPOSITION">IMAGE
  COMPOSITION</a></h1>
<p class="Pp">Each texture in an ANM file has an associated source image
    filename. By default <code class="Nm">thanm</code> creates textures by
    cropping the source image according to the following parameters:
    <var class="Va">xOffset</var>, <var class="Va">yOffset</var>,
    <var class="Va">THTXWidth</var>, <var class="Va">THTXHeight</var>. When
    extracting the textures, the process is reversed. However, because multiple
    textures may come from a single source file, they have to be composed
    together during extraction. Additionally, in either case, the textures have
    to be converted to/from the appropriate format.</p>
<dl class="Bl-tag">
  <dt>Composition when creating (<code class="Fl">-c</code>) or replacing
    (<code class="Fl">-r</code>):</dt>
  <dd>The source image is read from a file, decoded as PNG, cropped, and encoded
      in the texture format.</dd>
  <dt>Composition when extracting (<code class="Fl">-x</code>
    <span class="No">and</span> <code class="Fl">-X</code>):</dt>
  <dd>Each texture is decoded into RGBA, and placed on a canvas. The canvas is
      encoded as PNG and written to the destination file.</dd>
</dl>
<p class="Pp">The <code class="Fl">-u</code> option extracts each texture into
    its own file. It's important to also use the <code class="Fl">-u</code>
    option for listing (<code class="Fl">-l</code>), because
    <code class="Fl">-c</code> relies on the alternative filenames being
    specified in the spec file. Even with <code class="Fl">-u</code> the images
    are cropped/padded when they have an offset. The <code class="Fl">-uu</code>
    option ignores the offset, thereby disabling cropping/padding.</p>
<p class="Pp" id="never">In TH19, the textures are stored using PNG and JPEG
    compression. <code class="Nm">thanm</code> tries to avoid recompression when
    possible, so composition is only done when necessary. Uncompressed textures
    (pre-TH19) are always composed, even if only to convert them to PNG. PNGs
    are only composed only if there's a nonzero offset, or there are multiple
    textures referencing the same image. Otherwise the file is copied directly,
    without recompression (<code class="Fl">-uu</code> <span class="No">forces
    this behavior</span>). JPEGs are
    <a class="permalink" href="#never"><i class="Em">never</i></a> composed, but
    it shouldn't be necessary either. If a JPEG has to be composed,
    <code class="Nm">thanm</code> will issue a warning.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="ANMMAP_FILE_FORMAT"><a class="permalink" href="#ANMMAP_FILE_FORMAT">ANMMAP
  FILE FORMAT</a></h1>
<p class="Pp">Anmmap files, which are added with the <code class="Fl">-m</code>
    option, consist of two kinds of lines: control lines (which start with
    &#x2018;<code class="Li">!</code>&#x2019;), and mapping lines.</p>
<p class="Pp">The file starts with
    &#x2018;<code class="Li">!anmmap</code>&#x2019; control line. The rest of
    the control lines select the mapping that is being modified:</p>
<dl class="Bl-tag">
  <dt>&#x2018;<code class="Li">!ins_names</code>&#x2019;</dt>
  <dd>Instruction names. This is the default mapping.
    <br/>
    Value: identifier</dd>
  <dt>&#x2018;<code class="Li">!ins_signatures</code>&#x2019;</dt>
  <dd>Instruction signatures.
    <br/>
    Value: signature</dd>
  <dt>&#x2018;<code class="Li">!gvar_names</code>&#x2019;</dt>
  <dd>Global variable names.
    <br/>
    Value: identifier</dd>
  <dt>&#x2018;<code class="Li">!gvar_types</code>&#x2019;</dt>
  <dd>Global variable types.
    <br/>
    <span class="No">Value: type</span>
      (&#x2018;<code class="Li">$</code>&#x2019; for integer,
      &#x2018;<code class="Li">%</code>&#x2019; for float)</dd>
</dl>
<p class="Pp">Mapping lines are always of form</p>
<div class="Bd Bd-indent">[<var class="Ar">key</var>]
  [<var class="Ar">value</var>]</div>
where <var class="Ar">key</var> is an integer, and <var class="Ar">value</var>
  is a string without spaces. Empty values are allowed.
<p class="Pp">When multiple mappings are specified for the same key or value,
    the most recent one has priority. For example:</p>
<div class="Bd Pp Bd-indent Li">
<pre>123 foo
123 bar</pre>
</div>
<p class="Pp">will map &#x2018;<code class="Li">123</code>&#x2019; to
    &#x2018;<code class="Li">bar</code>&#x2019;,
    &#x2018;<code class="Li">bar</code>&#x2019; to
    &#x2018;<code class="Li">123</code>&#x2019;, and
    &#x2018;<code class="Li">foo</code>&#x2019; to
    &#x2018;<code class="Li">123</code>&#x2019;. Note how the first reverse
    mapping doesn't get removed.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp"><a class="Lk" href="https://github.com/thpatch/thtk">Project
    homepage</a></p>
</section>
<section class="Sh">
<h1 class="Sh" id="BUGS"><a class="permalink" href="#BUGS">BUGS</a></h1>
<p class="Pp">A few files from TH12 and TH13 contain overlapping entries with
    different formats. Dumping and recreating these archives will not result in
    the same archives. The affected pixels seem to all have 0 for alpha
  though.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SECURITY_CONSIDERATIONS"><a class="permalink" href="#SECURITY_CONSIDERATIONS">SECURITY
  CONSIDERATIONS</a></h1>
<p class="Pp">File names may not be properly sanitized when extracting.
    Furthermore, invalid data may not be properly handled. Do not operate on
    untrusted files.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">September 3, 2023</td>
    <td class="foot-os">thtk</td>
  </tr>
</table>
</body>
</html>
